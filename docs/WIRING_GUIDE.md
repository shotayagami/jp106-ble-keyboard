# JP106 BLE キーボード+トラックボール 配線ガイド

## 必要パーツ

| パーツ | 仕様 | 数量 |
|--------|------|------|
| Raspberry Pi Pico 2W | RP2350 + CYW43439 | 1 |
| Cherry MX互換キースイッチ | Red/Brown/Blue等 | 106 |
| 1N4148 シグナルダイオード | DO-35 | 106 |
| JISキーキャップセット | 日本語106配列 | 1式 |
| スタビライザー | Cherry式 2u/6.25u | 約8 |
| LiPoバッテリー | 3.7V 2000mAh JST-PH | 1 |
| MCP73831 充電IC | SOT-23-5 | 1 |
| AP2112K-3.3 LDOレギュレータ | 3.3V出力 | 1 |
| USB-Cブレークアウト | 充電用 | 1 |
| スライドスイッチ | SPDT | 1 |
| 抵抗 10kΩ | 0805 | 2 |
| セラミックコンデンサ 100nF | デカップリング | 5-10 |
| WS2812B (NeoPixel) | 5050 SMD | 3 |
| Pimoroni Trackball Breakout | PIM447 (I2C) | 1 |

---

## GPIO ピン割り当て

### 使用可能GPIO (26ピン)

Pico 2W: GP0-GP22, GP26-GP28

### 使用禁止GPIO (CYW43439 予約)

**GP23, GP24, GP25, GP29** は無線チップ (CYW43439) が使用。絶対に接続しないこと。

> **注意**: Pico 2W のオンボードLEDは GP25 ではなく CYW43439 経由で制御。
> コードでは `cyw43_arch_gpio_put(CYW43_WL_GPIO_LED_PIN, value)` を使用。

### ピン割り当て表

```text
マトリクス行 (OUTPUT, アクティブLOW):
  Row0 = GP0     Row4 = GP4
  Row1 = GP1     Row5 = GP5
  Row2 = GP2     Row6 = GP6
  Row3 = GP3     Row7 = GP7

マトリクス列 (INPUT, 内部プルアップ):
  Col0  = GP8    Col7  = GP15
  Col1  = GP9    Col8  = GP16
  Col2  = GP10   Col9  = GP17
  Col3  = GP11   Col10 = GP18
  Col4  = GP12   Col11 = GP19
  Col5  = GP13   Col12 = GP20
  Col6  = GP14   Col13 = GP21

WS2812B スロットLED (PIO駆動, デイジーチェーン):
  GP22 = WS2812B データ入力 (LED0→LED1→LED2)

トラックボール (I2C1):
  GP26 = I2C1 SDA
  GP27 = I2C1 SCL

バッテリー監視:
  GP28(ADC2) = バッテリー電圧 (分圧回路経由)
```

合計使用: 8(行) + 14(列) + 1(WS2812B) + 2(I2C) + 1(ADC) = 26/26ピン (全ピン使用)

---

## キースイッチ配線

### 1個分の配線 (全106キー共通)

```text
    Column (GPx, INPUT, 内部プルアップ)
        │
   ┌─────────┐
   │ スイッチ  │  ← Cherry MX互換
   └─────────┘
        │
   ─|◁|─┘      ← 1N4148: アノード=スイッチ側, カソード=行側
        │
    Row (GPy, OUTPUT)
```

**ダイオードの向き**: カソード (帯がある側) を行(Row)側に接続。
これによりゴースティングを防止し、NKRO を実現する。

### 動作原理

1. 行ピンを1本ずつ LOW に駆動 (他は HIGH)
2. 列ピンの内部プルアップにより、通常は HIGH
3. スイッチが押されると、その列ピンが LOW になる
4. ダイオードにより、隣接キーへの電流逆流を防止

---

## 8×14 フルマトリクス (日本語106キー配列)

```text
         Col0   Col1   Col2   Col3   Col4   Col5   Col6   Col7   Col8   Col9  Col10  Col11  Col12  Col13
         GP8    GP9    GP10   GP11   GP12   GP13   GP14   GP15   GP16   GP17   GP18   GP19   GP20   GP21
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row0 GP0─[半全]──[1]────[2]────[3]────[4]────[5]────[6]────[7]────[8]────[9]────[0]────[-]────[^]────[¥]───
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row1 GP1─[Tab]──[Q]────[W]────[E]────[R]────[T]────[Y]────[U]────[I]────[O]────[P]────[@]────[ [ ]──[BS]──
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row2 GP2─[Caps]─[A]────[S]────[D]────[F]────[G]────[H]────[J]────[K]────[L]────[;]────[:]────[ ] ]──[Ent]─
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row3 GP3─[LSft]─[Z]────[X]────[C]────[V]────[B]────[N]────[M]────[,]────[.]────[/]────[＼]───[↑]───[RSft]─
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row4 GP4─[LCtl]─[Win]──[LAlt]─[無変]─[Space]─[Fn]──[変換]─[かな]─[RAlt]─[RCtl]─[←]───[↓]───[→]───[   ]──
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row5 GP5─[F1]───[F2]───[F3]───[F4]───[F5]───[F6]───[F7]───[F8]───[F9]──[F10]──[F11]──[F12]──[Esc]──[   ]──
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row6 GP6─[PrtS]─[ScrL]─[Paus]─[Ins]──[Home]─[PgUp]─[Del]──[End]──[PgDn]─[NLk]──[KP/]──[KP*]─[KP-]─[   ]──
          │      │      │      │      │      │      │      │      │      │      │      │      │      │
Row7 GP7─[KP7]──[KP8]──[KP9]──[KP4]──[KP5]──[KP6]──[KP+]─[KP1]──[KP2]─[KP3]──[KP0]──[KP.]─[KPEn]─[   ]──

※ [   ] = 空きポジション (112中6箇所が未使用)
※ Row4/Col5 = Fn キー (ファームウェア専用、HIDには送信されない)
```

---

## 日本語固有キー

| キー | マトリクス位置 | HID Usage ID | 説明 |
|------|---------------|--------------|------|
| 半角/全角 | Row0, Col0 | `0x35` | 入力モード切替 (US grave位置) |
| ¥ / \| | Row0, Col13 | `0x89` | JIS固有: Yen/パイプ |
| ＼ / _ | Row3, Col11 | `0x87` | JIS固有: バックスラッシュ/アンダースコア |
| 無変換 | Row4, Col3 | `0x8B` | JIS固有: スペース左 |
| 変換 | Row4, Col6 | `0x8A` | JIS固有: スペース右 |
| カタカナ/ひらがな | Row4, Col7 | `0x88` | JIS固有: 変換キー右 |

---

## WS2812B スロットLED 配線

3個の WS2812B (NeoPixel) をデイジーチェーン接続。
PIO を使用した 800kHz シリアルプロトコルで駆動。

```text
                ┌──────────┐    ┌──────────┐    ┌──────────┐
GP22 ──── DIN ──┤ WS2812B  ├─── DIN ──┤ WS2812B  ├─── DIN ──┤ WS2812B  │
     (データ)   │  LED 0   │ DOUT     │  LED 1   │ DOUT     │  LED 2   │
                │ (スロット1)│          │ (スロット2)│          │ (スロット3)│
      VCC ──────┤ VCC      │──────────┤ VCC      │──────────┤ VCC      │
      GND ──────┤ GND      │──────────┤ GND      │──────────┤ GND      │
                └──────────┘          └──────────┘          └──────────┘
```

**電源**: WS2812B は 3.3V~5V で動作。Pico 2W の 3V3(OUT) ピンから給電可能。
3個の場合、最大消費電流は約 60mA (全白点灯時)。実際の使用では輝度を抑えるため数mA。

**デカップリングコンデンサ**: 各 WS2812B の VCC-GND 間に 100nF を配置推奨。

### LED色とスロット対応

| スロット | LED番号 | 色 | RGB値 |
|---------|---------|-----|-------|
| スロット1 | LED 0 | 緑 | (0, 32, 0) |
| スロット2 | LED 1 | 青 | (0, 0, 32) |
| スロット3 | LED 2 | 赤 | (32, 0, 0) |

### LED表示パターン

| 状態 | LED 0 | LED 1 | LED 2 | オンボードLED |
|------|-------|-------|-------|---------------|
| スロット1アクティブ | 緑点灯 | 消灯 | 消灯 | - |
| スロット2アクティブ | 消灯 | 青点灯 | 消灯 | - |
| スロット3アクティブ | 消灯 | 消灯 | 赤点灯 | - |
| BLE接続中 | - | - | - | 点灯 |
| BLE未接続 | - | - | - | 1Hz点滅 |
| スロット切替時 | 点滅 | 点滅 | 点滅 | - |

---

## トラックボール配線

Pimoroni Trackball Breakout (PIM447) を I2C1 で接続。

```text
Pimoroni Trackball         Pico 2W
┌───────────────┐
│ 3V3  ─────────────────── 3V3(OUT) (ピン36)
│ SDA  ─────────────────── GP26 (ピン31, I2C1 SDA)
│ SCL  ─────────────────── GP27 (ピン32, I2C1 SCL)
│ INT  ─── (未使用)
│ GND  ─────────────────── GND  (ピン33)
└───────────────┘
```

### I2C設定

| 項目 | 値 |
|------|-----|
| I2Cバス | I2C1 |
| SDAピン | GP26 |
| SCLピン | GP27 |
| I2Cアドレス | 0x0A |
| クロック周波数 | 100kHz |
| プルアップ | 内部プルアップ使用 |

### トラックボールの機能

- **ポインタ移動**: ボールの回転で X/Y 移動量を検出
- **クリック**: ボールを押し込むと左クリック
- **内蔵RGBW LED**: ステータス表示に使用可能

### HID マウスレポート (Report ID 2)

| バイト | 内容 | 範囲 |
|--------|------|------|
| 0 | ボタン (bit0=左, bit1=右, bit2=中) | 0x00-0x07 |
| 1 | X移動量 (右が正) | -127 to 127 |
| 2 | Y移動量 (下が正) | -127 to 127 |
| 3 | ホイール (上が正) | -127 to 127 |

> **注意**: トラックボールはオプショナル。未接続の場合、I2C検出に失敗し、
> キーボードのみのモードで動作する。

---

## バッテリー回路

### 電源系統

```text
USB-C ─→ MCP73831 (充電IC) ─→ LiPo 3.7V
                                    │
                              スライドスイッチ (ON/OFF)
                                    │
                              AP2112K-3.3 (LDO)
                                    │
                              3.3V ─→ Pico 2W VSYS
```

### バッテリー電圧監視 (分圧回路)

```text
LiPo (+) ── 10kΩ ──┬── 10kΩ ── GND
                    │
                  GP28 (ADC2)
```

ADC値からバッテリー電圧を算出:

- `Vbat = ADC_raw × 6.6 / 4095`
- 4.2V = 100%, 3.0V = 0%

---

## Pico 2W ピン配置図

```text
                    ┌─────────────────┐
  Row0        GP0  ─┤ 1            40 ├─ VBUS
  Row1        GP1  ─┤ 2            39 ├─ VSYS ← 3.3V LDO出力
              GND  ─┤ 3            38 ├─ GND
  Row2        GP2  ─┤ 4            37 ├─ 3V3_EN
  Row3        GP3  ─┤ 5            36 ├─ 3V3(OUT) → WS2812B/Trackball VCC
  Row4        GP4  ─┤ 6            35 ├─ ADC_VREF
  Row5        GP5  ─┤ 7            34 ├─ GP28/ADC2 ← バッテリー監視
              GND  ─┤ 8            33 ├─ GND
  Row6        GP6  ─┤ 9            32 ├─ GP27 ← I2C1 SCL (トラックボール)
  Row7        GP7  ─┤10            31 ├─ GP26 ← I2C1 SDA (トラックボール)
  Col0        GP8  ─┤11            30 ├─ RUN
  Col1        GP9  ─┤12            29 ├─ GP22 ← WS2812B データ
              GND  ─┤13            28 ├─ GND
  Col2       GP10  ─┤14            27 ├─ GP21  Col13
  Col3       GP11  ─┤15            26 ├─ GP20  Col12
  Col4       GP12  ─┤16            25 ├─ GP19  Col11
  Col5       GP13  ─┤17            24 ├─ GP18  Col10
              GND  ─┤18            23 ├─ GND
  Col6       GP14  ─┤19            22 ├─ GP17  Col9
  Col7       GP15  ─┤20            21 ├─ GP16  Col8
                    └─────────────────┘
```

---

## PCB 設計のポイント

1. **2層基板 (FR4)** 推奨: 表面にスイッチ、裏面に配線
2. **ダイオードの配置**: 各スイッチの裏面に 1N4148 を配置
3. **Pico 2W の実装**: ピンヘッダまたは直接ハンダ付け
4. **USB-C コネクタ**: 充電専用 (データ線不要)
5. **バッテリーコネクタ**: JST-PH 2ピン
6. **トラックボール取付穴**: PCBにM2マウントホールを配置
7. **WS2812B**: 3個を直列配線、各LEDにデカップリングコンデンサ

---

## 組み立て手順

1. PCBにキースイッチ用ソケット (またはスイッチ直接) を実装
2. 全106箇所に 1N4148 ダイオードをハンダ付け (向きに注意!)
3. Pico 2W をピンヘッダで実装
4. バッテリー回路 (充電IC + LDO + 分圧抵抗) を実装
5. WS2812B LED 3個をデイジーチェーン配線 (GP22 → LED0 → LED1 → LED2)
6. トラックボールモジュールを I2C 接続 (GP26=SDA, GP27=SCL, 3V3, GND)
7. スイッチを挿入、キーキャップを装着
8. ファームウェアを書き込み (BOOTSEL → UF2コピー)
9. BLE ペアリングテスト
10. トラックボール動作テスト

---

## Fnキー操作

マトリクス Row4/Col5 (Spaceキーの右隣) に Fn キーを配置。

| 操作 | 機能 |
|------|------|
| Fn + 1 | デバイススロット1に切替 |
| Fn + 2 | デバイススロット2に切替 |
| Fn + 3 | デバイススロット3に切替 |

- 切替時: 現在の接続を切断 → 新スロットでアドバタイジング開始
- 未ペアリングスロット: 新規ペアリングモード
- ペアリング済みスロット: 登録デバイスに再接続
- ペアリング情報はFlashに永続化 (電源OFFでも保持)

---

## コンポジットHIDデバイス

本キーボードは BLE HID コンポジットデバイスとして動作する。
1つのBLE接続で、キーボードとマウス (トラックボール) の両方を処理。

### HID レポート構成

| Report ID | デバイス | プロトコル | サイズ |
|-----------|---------|-----------|--------|
| 1 | キーボード | Report Protocol (NKRO) | 22バイト |
| 2 | マウス | Report Protocol | 4バイト |
| - | キーボード | Boot Protocol (6KRO) | 8バイト |

- **Report Protocol**: OS起動後に使用。NKRO + マウス対応。
- **Boot Protocol**: BIOS/UEFI用。6KROキーボードのみ (マウス無効)。
